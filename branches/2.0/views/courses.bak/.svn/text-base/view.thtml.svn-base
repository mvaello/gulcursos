
<?php
	echo "
		<h1> {$course[0]['Course']['title']} </h1>
		<div id='shortdescription'> {$course[0]['Course']['description']} </div>
	";
	
	$closed           = $course[0]['Course']['closed'];
	$allowedProposals = $course[0]['Course']['proposals'];
	$allowedVotes     = $course[0]['Course']['votes'];

	if ($allowedVotes > 0)
	{
		echo "<p>Estos son los cursos propuestos para estas jornadas. 
		Los cursos m&aacute;s votados ser&aacute;n los que se lleven a cabo.
		Si te interesa alguno puedes votarlo
		pulsando en el enlace de su t&iacute;tulo</p>";
	}
	else
	{
		echo "<p>Aquí se muestran los cursos que van a darse en esta jornada
		Si quieres saber m&aacute;s sobre un curso pulsa en su t&iacute;tulo"; 
	}
?>

<p>
	Quizá te interese ver el <?php echo $html->link("calendario de estas jornadas (beta)", "/courses/calendar/".$course[0]['Course']['id']);?>

<?php
	if ($allowedVotes > 0)
	{
		echo "Recuerda que estamos en plena organizaci&oacute;n, por lo que el calendario no estar&aacute; completo.";
	}
?>
</p>


<table>
	<tr class="head">
		<th> Nombre del curso </th>
		<th> <a href="/courses/view/<?php echo $course[0]['Course']['id']?>/date">Fecha </a></th>
		<th> Hora </th>
		<th> Votos y comentarios </th>
		<th> <a href="/courses/view/<?php echo $course[0]['Course']['id']?>/mark">Puntuación </a></th>
		<th> Asistentes confirmados </th>
		
		<?php
		if ($session->check("User"))
		{
			echo "<th> Acciones </th>";
		}
		?>
	</tr>
	
	<?php 
	
	$i = 0;
	foreach($course[0]['Lecture'] as $lecture)
	{
		$id = $lecture['id'];
		$class = "plain";
		if ($i++ % 2 == 1)
			$class="alt";

		$nVotes = count($lecture['Vote']);
		$totalMark = 0;
		
		foreach($lecture['Vote'] as $vote)
		{
			$totalMark += $vote['mark'];
		}
		
		$totalMark = $nVotes==0?'':$totalMark;
		$nVotes = $nVotes==0?'':$nVotes;
		
		$nPupils = count($lecture['Pupil']);
		$nPupils = $nPupils>0?$nPupils:"";
		
		echo "
		<tr class=\"$class\">
			<td> {$html->link($lecture['title'], "/lectures/view/{$id}")} <div style='font-size:10px;color:#888'>".$lecture['teacher']." </div></td>
			<td> {$lecture['date']}	</td>
			<td> ".substr($lecture['startingtime'], 0, 5)." - ".substr($lecture['endingtime'], 0, 5)."</td>
			<td> $nVotes </td>
			<td> $totalMark	</td>
			<td> $nPupils	</td>
		";

		if ($session->check("User"))
		{
			echo "<td> 
			{$html->link("Editar", "/lectures/edit/{$id}")}";
			
//			if (!$closed)
			echo "
			|
			{$html->link("Borrar", "/lectures/delete/{$id}/{$course[0]['Course']['id']}")}
			</td>";
		}
		echo "</tr>";
	}
	?>
</table>

<?php
	
	if ($closed != 1)
	{
		
		if ($allowedProposals > 0)
		{
?>

<h2> ¿Alguna propuesta? </h2>
<p>
	¿Tienes alguna propuesta de curso para estas jornadas? ¿Te interesa un tema y no hay charlas sobre ello? ¡Abre la boca!
</p>
<p> 
	Mándanos una propuesta y el resto de la comunidad podrá verla y votarla. Incluso puedes proponer al ponente y ganarte su enemistad. 	
</p>	

<p>
	Hmmm... ¿Que eres tú quien quiere dar ese curso? Pues proponte a ti mismo como ponente, alma de cántaro :)
</p>
	
<p>
	<form action='<?php echo $html->url("/lectures/propose"); ?>' method='post'>
		<?php echo $html->hidden("Lecture/course", 
			array('class' => 'hidden', 'value' => $course[0]['Course']['id'])); ?>

		<p> 
			Curso propuesto:
			<?php echo $html->input("Lecture/title", array('size' => 30, 'maxlength' => 200)); ?>
		</p>
		
		<p>
			Ponente propuesto: 
			<?php echo $html->input("Lecture/teacher", array('size' => 30, 'maxlength' => 50)); ?>
		</p>

		<p>
			Una peque&ntilde;a descripci&oacute;n, por favor: 
			<?php echo $html->input("Lecture/briefdescription", array('size' => 30)); ?>
		</p>
		
		<p>
			<?php echo $html->submit("Enviar propuesta"); ?>
		</p>
	</form>
</p>

<?php
	}
}
?>







<?php
	function calendar($date)
    {
         //If no parameter is passed use the current date.
         if($date == null)
            $date = getDate();
            
         $day = $date["mday"];
         $month = $date["mon"];
         $month_name = $date["month"];
         $year = $date["year"];
         
         $this_month = getDate(mktime(0, 0, 0, $month, 1, $year));
         $next_month = getDate(mktime(0, 0, 0, $month + 1, 1, $year));
         
         //Find out when this month starts and ends.         
         $first_week_day = $this_month["wday"];
         $days_in_this_month = round(($next_month[0] - $this_month[0]) / (60 * 60 * 24));
                          
         $calendar_html = "<table style=\"background-color:666699; color:ffffff;\">";
         
         $calendar_html .= "<tr><td colspan=\"7\" align=\"center\" style=\"background-color:9999cc; color:000000;\">" . 
                           $month_name . " " . $year . "</td></tr>";
                           
         $calendar_html .= "<tr>";
          
         //Fill the first week of the month with the appropriate number of blanks.       
         for($week_day = 0; $week_day < $first_week_day; $week_day++)
            {
            $calendar_html .= "<td style=\"background-color:9999cc; color:000000;\"> </td>";   
            }
            
         $week_day = $first_week_day;
         for($day_counter = 1; $day_counter <= $days_in_this_month; $day_counter++)
            {
            $week_day %= 7;
            
            if($week_day == 0)
               $calendar_html .= "</tr><tr>";
            
            //Do something different for the current day.
            if($day == $day_counter)   
               $calendar_html .= "<td align=\"center\"><b>" . $day_counter . "</b></td>";
            else
               $calendar_html .= "<td align=\"center\" style=\"background-color:9999cc; color:000000;\">&nbsp;" .
                                 $day_counter . " </td>";
            
            $week_day++;
            }
            
         $calendar_html .= "</tr>";
         $calendar_html .= "</table>";
                   
         return($calendar_html);
    }
?>

<?php
echo $html->link("Volver a la lista de jornadas", "/courses/");
echo " | ";
echo $html->link("Nuevo curso", "/lectures/add/{$course[0]['Course']['id']}/{$course[0]['Course']['title']}");
?>
